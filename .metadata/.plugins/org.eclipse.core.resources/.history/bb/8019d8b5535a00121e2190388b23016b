package com.ivtolkachev.facebookfriends.data;

import java.util.ArrayList;

import com.ivtolkachev.facebookfriends.model.User;

import android.content.Context;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.database.sqlite.SQLiteException;
import android.util.Log;

public class DatabaseWorker {

	private static final String TAG = "DatabaseWorkerTag";
	
	private static DatabaseWorker instance = null;
	private SQLiteDatabase db;
	private DatabaseHelper dbHelper;
	
	private DatabaseWorker(Context context){
		dbHelper = new DatabaseHelper(context);
	}
	
	/**
	 * The method initializes an instance of DatabaseWorker if it is need and returns it.
	 * @param context the ApplicationContext
	 * @return an instance of DatabaneWorker.
	 */
	public static DatabaseWorker getDatabaseWorker(Context context){
		if (instance == null) {
			 instance = new DatabaseWorker(context);
		}
		return instance;
	}
	
	/**
	 * The method opens connection with database.
	 * @param context the ApplicationContext
	 */
	public void openDB(){
		if (!db.isOpen()){
			try {
				db = dbHelper.getWritableDatabase();
			} catch (SQLiteException e) {
				Log.e(TAG, "Error with opening of db.");
				e.printStackTrace();
			}
		}
	}
	
	public void closeDB(){
		db.close();
	}
	
	/**
	 * The method extracts the data of users from the database.
	 * @return a list of users.
	 */
	public synchronized ArrayList<User> getUsers(){
		ArrayList<User> users = new ArrayList<User>();
		if (db.isOpen()){
			Cursor cursor = db.query(DatabaseHelper.USERS_TABLE, null, null, null, null, null, null);
			while (cursor.moveToNext()) {
				ArrayList<String> userContacts = new ArrayList<String>();
				User user = new User(
						cursor.getLong(DatabaseHelper.ID_USER_ID),
						cursor.getString(DatabaseHelper.ID_USER_NAME), 
						cursor.getString(DatabaseHelper.ID_USER_SURNAME), 
						cursor.getLong(DatabaseHelper.ID_USER_BIRTH), 
						cursor.getString(DatabaseHelper.ID_USER_BIO), 
						userContacts);
				users.add(user);
			}
		} else {
			Log.e(TAG, "The database has not opened!");
		}
		return users;
	}
	
}
